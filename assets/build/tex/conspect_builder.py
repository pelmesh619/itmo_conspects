import os
import re
import time
from pathlib import Path

from assets.build.conspect_builder import ConspectBuilder


class TexConspectBuilder(ConspectBuilder):
    DISCLAIMER = f"%% This file is generated by {__module__}. All changes to it will be lost %%\n\n"

    AUXIL_DIRECTORY = 'auxil'

    def __init__(self, input_filename, output_filename, linted_directory='linted'):
        super().__init__(input_filename, output_filename)

        self.linted_directory = linted_directory

    @property
    def conspect_filename(self):
        if self.output_filename is None:
            return Path("conspects") / Path(self.input_filename).parent / (Path(self.input_filename).stem + ".pdf")

        return self.output_filename

    def insert_displaystyle(self, text):
        to_display = True

        for i in list(re.finditer(r'(\$.+?\$)|(%nodisplay)|(%yesdisplay)', text, re.MULTILINE | re.DOTALL)):
            if '%nodisplay' in i.group(0):
                to_display = False
            if '%yesdisplay' in i.group(0):
                to_display = True

            if not to_display:
                continue

            if r'\displaystyle' in i.group(0):
                continue
            if any(map(lambda x: x in i.group(0), [r'\frac', r'\sum', r'\int', r'\iint', r'\iiint', '^', '_', r'\lim'])):
                text = text.replace(i.group(0), r'$\displaystyle ' + i.group(0)[1:])

        return text

    def get_specific_preamble(self):
        preamble_path = Path(self.input_filename).parent / '__preamble.sty'
        if preamble_path.exists() and preamble_path.is_file():
            specific_preamble = open(preamble_path, encoding='utf8').read()

            return specific_preamble

        return ''


    def build(self, args):
        print(f'Compiling {self.input_filename}...\n')

        text = self.DISCLAIMER

        file_text = open(self.input_filename, encoding='utf8').read()

        if '\\begin{document}' in file_text:
            file_text = file_text.replace('\\begin{document}', self.get_specific_preamble() + '\n\\begin{document}')
        else:
            file_text = self.get_specific_preamble() + '\n' + file_text

        text += file_text

        text = self.insert_displaystyle(text)

        if not os.path.exists(self.linted_directory):
            os.mkdir(self.linted_directory)

        linted_output = Path(self.linted_directory) / Path(self.input_filename).name
        open(linted_output, 'w', encoding='utf8').write(text)

        interaction = 'nonstopmode' if args.verbose else 'batchmode'

        start_time = time.time()

        command = (
            f"latexmk "
            f"-time -pdf {'-f' if args.force else ''} {'' if args.bibtex else '-nobibtex'} "
            f"-output-directory=\"{str(Path(self.conspect_filename).parent)}\" "
            f"-aux-directory={self.AUXIL_DIRECTORY} "
            f"{linted_output} "
            f"-interaction={interaction} -file-line-error "
        )

        print(f"Running: {command}")

        exit_code = os.system(command)

        if exit_code == 0:
            print(f'Compilation of {self.conspect_filename} completed in {round(time.time() - start_time, 2)} s!')
        else:
            print(
                f'Compilation of {self.conspect_filename} failed. '
                f'Check {Path(self.AUXIL_DIRECTORY) / (Path(self.input_filename).stem + '.log')} for more info'
            )
        return exit_code

