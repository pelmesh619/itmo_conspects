import os
import re
from pathlib import Path

from assets.build.superconspect_builder import SuperconspectBuilder
from assets.build.tex.conspect_builder import TexConspectBuilder


class TexSuperconspectBuilder(SuperconspectBuilder):
    DISCLAIMER = f"%% This file is generated by {__module__}. All changes to it will be lost %%\n\n"
    BEGIN_FILE_LABEL = "%% begin {} %%\n"
    END_FILE_LABEL = "\n%% end {} %%\n\n"

    FILE_EXTENSION = '.tex'

    def __init__(self, input_folder, blacklist_words, output_filename=None):
        super().__init__(input_folder, blacklist_words, output_filename)

        self.level = len(list(i for i in os.path.split(input_folder) if i))

        self.subject_name = None
        self.lecturer_name = None
        self.top_level_header = None


    def filter(self, file_text):
        return re.sub(r'(\t\r )*%+\s*ignore.*?((%+\s*noignore)|($))', '', file_text, flags=re.UNICODE | re.DOTALL).strip()

    def collect_variables(self, file_text):
        if self.subject_name is None:
            if subject_match := re.search(r'\\fancyhead\[LO,L(E)?]\{(.*)}', file_text):
                self.subject_name = subject_match.group(2)
            elif subject_match := re.search(r'\$subject\$=(.*)\n', file_text):
                self.subject_name = subject_match.group(2)
                file_text = file_text.replace(subject_match.group(0), '', 1)

        if self.lecturer_name is None:
            if lecturer_name_match := re.search(r'\\fancyhead\[RO,R(E)?]\{(.*)}', file_text):
                self.lecturer_name = lecturer_name_match.group(2)
            elif lecturer_name_match := re.search(r'\$teacher\$\s*=\s*(.*)\n', file_text):
                self.lecturer_name = lecturer_name_match.group(1)
                file_text = file_text.replace(lecturer_name_match.group(0), '', 1)

        return file_text

    def get_prepared_text(self, text):
        match = re.search(r'\\begin\{document\}(.+?)\n*\\end\{document\}', text, re.S | re.M | re.I)

        if not match:
            match_text = text
            for j in re.finditer(r'((\n)|(^))(\$\w+\$)\=(.*)', match_text):
                match_text = match_text.replace(j.group(0), '\n', 1)
        else:
            match_text = match.group(1)

        return match_text


    def build(self, args):
        folder_files = [i for i in os.listdir(self.input_folder) if not i.startswith('__')]
        folder_files.sort()

        preamble_location = os.path.join(*(['..'] * self.level), 'preamble.typ')

        text = ''

        for i in folder_files:
            if not i.endswith('.tex') or any([j in i for j in self.blacklist_words]):
                continue

            t = open(os.path.join(self.input_folder, i), 'r', encoding='utf8').read()

            t = self.filter(t)
            if not t:
                print(f'File `{i}` ignored')
                continue

            t = self.collect_variables(t)

            t = self.get_prepared_text(t)

            text += self.BEGIN_FILE_LABEL.format(i)
            text += t
            text += self.END_FILE_LABEL.format(i)

        text = re.sub(r'section\[.*]', 'section', text)
        text = (
            open('assets/build/tex/superconspect_template.tex', encoding='utf8').read()
                .replace('$conspects$', text)
                .replace('$subject$', self.subject_name)
                .replace('$teacher$', self.lecturer_name)
        )

        open(self.superconspect_filename, 'w', encoding='utf8').write(text)

        os.system("python linter.py " + str(self.superconspect_filename) + ("--verbose" if args.verbose else ""))
