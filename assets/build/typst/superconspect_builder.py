import os
import re
from pathlib import Path

from assets.build.superconspect_builder import SuperconspectBuilder


class TypstSuperconspectBuilder(SuperconspectBuilder):
    DISCLAIMER = f"// This file is generated by {__module__}. All changes to it will be lost\n\n"
    BEGIN_FILE_LABEL = "// begin {} \n"
    END_FILE_LABEL = "\n// end {} \n\n"

    FILE_EXTENSION = '.typ'

    def __init__(self, input_folder, blacklist_words, output_filename=None):
        super().__init__(input_folder, blacklist_words, output_filename)

        self.level = len(list(i for i in Path(input_folder).parts if i))

        self.subject_name = None
        self.lecturer_name = None
        self.top_level_header = None

    def filter(self, file_text):
        return re.sub(r'(\t\r )*//+\s*ignore.*?((//+\s*noignore)|($))', '', file_text, flags=re.UNICODE | re.DOTALL).strip()

    def collect_variables(self, file_text):
        if self.subject_name is None:
            subject_match = re.search(r'#let subject-name = \[(.+)\]', file_text)
            if subject_match is not None:
                self.subject_name = subject_match.group(1)

        if self.lecturer_name is None:
            lecturer_name_match = re.search(r'#let lecturer-name = \[(.+)\]', file_text)
            if lecturer_name_match is not None:
                self.lecturer_name = lecturer_name_match.group(1)

        if self.top_level_header is None:
            top_level_header_match = re.search(r'^=\s+(.+)', file_text, re.M)
            if top_level_header_match is not None:
                self.top_level_header = top_level_header_match.group(1)
                file_text = re.sub(r'^=\s+(.+)', '', file_text, count=1, flags=re.M)

        return file_text

    def build(self, args):
        folder_files = [i for i in os.listdir(self.input_folder) if not i.startswith('__')]
        folder_files.sort()

        preamble_location = os.path.join(*(['..'] * self.level), 'preamble.typ')

        print(preamble_location, self.level, self.input_folder)

        text = ''

        for i in folder_files:
            if not i.endswith('.typ') or any([j in i for j in self.blacklist_words]):
                continue

            t = open(os.path.join(self.input_folder, i), 'r', encoding='utf8').read()

            t = self.filter(t)

            if not t:
                print(f'File `{i}` ignored')
                continue

            t = self.collect_variables(t)

            while re.search(r'^\s*\#(let|show|import)[^\n]*?(\(.+?\))?\n+', t, re.S):
                t = re.sub(r'^\s*\#(let|show|import)[^\n]*?(\(.+?\))?\n+', '', t, count=1, flags=re.S)

            text += self.BEGIN_FILE_LABEL.format(i)
            text += t
            text += self.END_FILE_LABEL.format(i)

        text = self.DISCLAIMER + (
            open('assets/build/typst/superconspect_template.typ', encoding='utf8').read()
                .replace('$conspects$', text)
                .replace('$subject_name$', self.subject_name)
                .replace('$lecturer_name$', self.lecturer_name)
                .replace('$top_level_header$', self.top_level_header)
                .replace('$preamble_location$', preamble_location)
        )
        open(self.superconspect_filename, 'w', encoding='utf8').write(text)

        os.system("python build.py " + str(self.superconspect_filename))
