\ProvidesPackage{preamble}

% Thanks @Lipen for this preamble

\usepackage{cmap}
\usepackage[T2A, T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[english,russian]{babel}

\usepackage{amsthm,thmtools}
\usepackage{amsmath,mathtools}
\usepackage{amssymb}
\usepackage[libertine,smallerops]{newtxmath}
\usepackage{microtype}
\usepackage[margin=2cm,bottom=2cm]{geometry}
\usepackage[usenames,dvipsnames,svgnames]{xcolor}
\usepackage{graphicx}
\usepackage{wrapfig}
\usepackage{pdfpages}
\usepackage{setspace}
\usepackage{multicol}
\usepackage{multirow}
\usepackage{booktabs}
\usepackage[skip=2pt]{caption}
\usepackage{scalerel}
\usepackage[Export]{adjustbox}
\usepackage[autostyle]{csquotes}
\usepackage{xifthen}
\usepackage{cancel}
\usepackage[normalem]{ulem}
\usepackage{centernot}
\usepackage{float}
\usepackage{bm}
\usepackage[shortcuts]{extdash}
\usepackage{fancyhdr}
\setlength{\headheight}{28pt}
\setlength{\footskip}{20pt}
\addtolength{\topmargin}{0pt}

\usepackage{enumitem}
\usepackage{tabularx}
\usepackage{titlesec}
\usepackage{fontawesome5}
\usepackage{lipsum}
\usepackage{ragged2e}
\usepackage[user,lastpage]{zref}
\usepackage{silence}
\usepackage{datetime2}
\usepackage{witharrows}
\usepackage{nicematrix}
\usepackage{footnotebackref}

\usepackage{hwemoji}
\usepackage{environ}

\usepackage{tcolorbox}
\usepackage{varwidth}
\tcbuselibrary{most}

% Fix mapping for ligatures
% https://tex.stackexchange.com/a/450394
\input glyphtounicode
\pdfgentounicode=1

% To not number sections in contents
\setcounter{secnumdepth}{0}

% Making no indent EVERYWHERE
\setlength{\parindent}{0pt}

% Change between-lines spacing
\onehalfspacing


% Tikz setup
\usepackage{tikz}
\usetikzlibrary{
    arrows.meta,
    backgrounds,
    calc,
    decorations.pathreplacing,
    decorations.pathmorphing,
    fit,
    matrix,
    patterns,
    positioning,
    shapes.misc,
    automata,
    shapes
}
\tikzstyle{every text node part}=[align=center]

\tikzset{
    position/.style args={#1:#2 from #3}{
        at=(#3.#1), anchor=#1+180, shift=(#1:#2)
    },
    dot/.style={
        draw,
        fill=black,
        shape=circle,
        minimum size=4pt,
        inner sep=0pt,
        outer sep=0pt,
    },
}
\tikzstyle{mygraphstyle}=[
    auto,
    on grid,
]
\tikzstyle{myautomatonstyle}=[
    auto, on grid,
    >={Stealth[]},
    shorten >=1pt,
    semithick,
    bend angle=15,
    initial text={},
    every state/.style={
        inner sep=0pt,
        minimum size=2em,
    },
]

% Setup column types
\usepackage{array}
\newcolumntype{\ML}[1]{>{$}\ml{#1}<{$}}
\newcolumntype{\MC}[1]{>{$}\mc{#1}<{$}}
\newcolumntype{\MR}[1]{>{$}\mr{#1}<{$}}
\newcolumntype{\ml}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{\mc}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{\mr}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{L}{>{$}l<{$}}
\newcolumntype{C}{>{$}c<{$}}
\newcolumntype{R}{>{$}r<{$}}
\newcolumntype{B}{>{$\boldmath$}c}
\newcolumntype{Y}{>{$}X<{$}}
\newcolumntype{\BC}{>{\boldmath$}c<{$}}

% Spacing above and below multicol environment
% By default \setlength{\multicolsep}{12pt plus 4pt minus 3pt}
\setlength{\multicolsep}{2pt plus 6pt minus 0pt}

% Setup display glue
% By default
% \AtBeginDocument{
% \setlength{\abovedisplayskip}{12pt plus 3pt minus 9pt}
% \setlength{\belowdisplayskip}{12pt plus 3pt minus 9pt}
% \setlength{\abovedisplayshortskip}{0pt plus 3pt}
% \setlength{\belowdisplayshortskip}{7pt plus 3pt minus 4pt}
% }
\AtBeginDocument{
\setlength{\abovedisplayskip}{4pt plus 8pt minus 2pt}
\setlength{\belowdisplayskip}{8pt plus 4pt minus 6pt}
\setlength{\abovedisplayshortskip}{0pt plus 4pt}
\setlength{\belowdisplayshortskip}{5pt plus 5pt minus 2pt}
}

% Setup muglue
% By default
% \thickmuskip=5mu plus 5mu
% \medmuskip=4mu plus 2mu minus 4mu
% \thinmuskip=3mu
\thickmuskip=4mu plus 4mu minus 1mu
\medmuskip=3mu plus 3mu minus 2mu
\thinmuskip=3mu

% Setup float spacings
% Space to intext float
\setlength{\intextsep}{6pt plus 4pt minus 2pt}
% Space between text and arbitrary float
\setlength{\textfloatsep}{6pt plus 4pt}

% Force TeX not to break in math mode (9999 = almost never)
\relpenalty=9999
\binoppenalty=9999

% Emergency stretch
\emergencystretch=1em

% Setup separator for lists
\setlist{noitemsep, topsep=0pt}

\newboolean{is-adjustbox-cframe}

% Setup hyperref
\usepackage{hyperref}
\hypersetup{
    breaklinks=true,
    pdfstartview=,
    pdfauthor={},
    pdfsubject={},
    allcolors=black,
    urlcolor=blue,
    linkcolor=DodgerBlue,
    colorlinks=true,
}


% Footnote backreference
% https://tex.stackexchange.com/a/78438
\makeatletter
\LetLtxMacro{\BHFN@Old@footnotemark}{\@footnotemark}
\renewcommand*{\@footnotemark}{%
    \refstepcounter{BackrefHyperFootnoteCounter}%
    \xdef\BackrefFootnoteTag{bhfn:\theBackrefHyperFootnoteCounter}%
    \label{\BackrefFootnoteTag}%
    \BHFN@Old@footnotemark
}
\makeatother


% MACROS 
% =======================

% Missing big greek letters
\providecommand{\Alpha}{\mathrm{A}}
\providecommand{\Beta}{\mathrm{B}}
\providecommand{\Epsilon}{\mathrm{E}}
\providecommand{\Zeta}{\mathrm{Z}}
\providecommand{\Iota}{\mathrm{I}}
\providecommand{\Kappa}{\mathrm{K}}
\providecommand{\Mu}{\mathrm{M}}
\providecommand{\Nu}{\mathrm{N}}
\providecommand{\Tau}{\mathrm{T}}
\providecommand{\Chi}{\mathrm{X}}

% Current font size
\makeatletter
\newcommand\thefontsize{\f@size}
\makeatother

% Cat symbol
\newcommand\CatSymbol[1]{% {<height>}
    \includegraphics[height=#1]{assets/Cat.pdf}}
\newcommand\Cat[1][\thefontsize pt]{% [<height>]
    \smash[b]{\raisebox{-0.2\height}{\CatSymbol{#1}}}}

% Circle symbol
\let\oldcircle\circle
\renewcommand\circle{%
    \mathord{\scalerel*{\tikz \draw circle[radius=0.7ex];}{A}}}


% Some number sets
\newcommand\Bool{\mathbb{B}}
\newcommand\Natural{\mathbb{N}}
\newcommand\NaturalPlus{\Natural^{+}}
\newcommand\NaturalZero{\Natural_{0}}
\newcommand\Integer{\mathbb{Z}}
\newcommand\PositiveInteger{\Integer^{+}}
\newcommand\Rational{\mathbb{Q}}
\newcommand\Real{\mathbb{R}}

% Empty and universal sets
\renewcommand\emptyset{\varnothing}
\newcommand\universalset{\mathfrak{U}}

% Bracket syntaxes
\DeclarePairedDelimiter{\Set}\{\}
\DeclarePairedDelimiter{\Pair}\langle\rangle
\DeclarePairedDelimiter{\Ceil}\lceil\rceil
\DeclarePairedDelimiter{\Floor}\lfloor\rfloor
\DeclarePairedDelimiter{\Round}\lbrack\rbrack

% Union and intersection operators
\newcommand\union{\cup}
\newcommand\intersection{\cap}
\newcommand\bigunion{\bigcup}
\newcommand\bigintersection{\bigcap}

% Xor operator
\newcommand\xor{\oplus}
\newcommand\lxor{\mathbin{\veebar}}

% Single-line arrows for implication and iff
\def\implies{\mathrel{\rightarrow}}
\def\impliedby{\mathrel{\leftarrow}}
\def\iff{\mathrel{\leftrightarrow}}

% Let symbol (like ] but wider)
\newcommand\letsymbol{\mathord{\sqsupset}}

% Macros for vertical spaces
\newcommand{\smallvspace}{\vspace{3mm}}
\newcommand{\mediumvspace}{\vspace{6mm}}
\newcommand{\bigvspace}{\vspace{10mm}}


% Some in-text labels
% Nota - to note (aka NB)
% Def - for definition
% Mem - 'Memento', to remember
% Lab - for self-study
% Th - theorem

% Suffixes:
% s - for silent
% N - for number (or another text after label)

\newcommand{\Notas}{\textit{Nota. }}

\newcommand{\Nota}{ \vspace{5mm}%
%
\Notas%
}
\newcommand{\NotaN}[1]{\Nota\textit{#1.}}

\newcommand{\Defs}{\textbf{Def. }}
\newcommand{\Def}{ \vspace{5mm}%
%
\Defs}
\newcommand{\DefN}[1]{\Def\textbf{#1.}}
\newcommand{\DefNs}[1]{\Defs\textbf{#1.}}

\newcommand{\Mems}{\textit{Mem. }} % s - for silent
\newcommand{\Mem}{ \vspace{5mm}%
%
\Mems%
}
\newcommand{\MemN}[1]{\Mem\textit{#1.}}

\newcommand{\Ths}{\textbf{Th. }} % s - for silent
\newcommand{\Th}{ \vspace{5mm}%
%
\Ths}
\newcommand{\ThN}[1]{\Th\textbf{#1.}}
\newcommand{\ThNs}[1]{\Ths\textbf{#1.}}

\newcommand{\Exs}{\textit{Ex. }} % s - for silent
\newcommand{\Ex}{ \vspace{5mm}%
%
\Exs%
}
\newcommand{\ExN}[1]{\Ex\textit{#1.}}
\newcommand{\ExNs}[1]{\Exs\textit{#1.}}

\newcommand{\Lab}{\underline{Lab. }}
\newcommand{\LabN}[1]{\Lab\textbf{#1.}}


% Square cases environment (for set of equations)
\makeatletter
\newenvironment{sqcases}{%
  \matrix@check\sqcases\env@sqcases
}{%
  \endarray\right.%
}
\def\env@sqcases{%
  \let\@ifnextchar\new@ifnextchar
  \left\lbrack
  \def\arraystretch{1.2}%
  \array{@{}l@{\quad}l@{}}%
}
\makeatother

% Environment for theorem
\newenvironment{MyTheorem}
    {\begin{tcolorbox}[colframe=blue!25, colback=blue!10]
    }
    {
    \end{tcolorbox}
    }

% Environment for proof
\newenvironment{MyProof}
    {\begin{tcolorbox}[breakable]
    }
    {
    \end{tcolorbox}
    }

% Environment for upside down text block
\NewEnviron{UpsideDown}
{%
\noindent
\rotatebox[origin=c]{180}{%
\noindent
\begin{minipage}[t]{\linewidth}
\BODY
\end{minipage}%
}%
}%