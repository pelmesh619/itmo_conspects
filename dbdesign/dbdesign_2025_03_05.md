## Лекция 4. Архитектура PostgreSQL

### Postmaster

При запуске PostgreSQL сервере первым делом создается процесс Postmaster. **Postmaster** - главный процесс, который принимает входящие подключения от клиентов, управляет созданием и завершением дочерних процессов

Для каждого нового подключения Postmaster порождает отдельный процесс, который обрабатывает SQL-запросы, выполняет планирование и возвращает результаты клиенту. Такой подход изолирует сессии и повышает стабильность системы

### Фоновые процессы (Background Workers)

PostgreSQL использует дополнительные фоновые процессы для выполнения служебных задач:

* **Checkpointer** периодически сбрасывает измененные данные из общей памяти (shared buffers) на диск. Это снижает время на восстановление после сбоев и оптимизирует запись: данные сначала попадают в буфер, а затем периодически записываются на диск

* **WAL Writer** обеспечивает запись журналов предзаписи (Write-Ahead Logging, WAL), что гарантирует, что изменения сначала фиксируются в журнале, прежде чем быть записанными на диск. WAL Writer используется для обеспечения надежности и возможности восстановления

* **Background Writer** фоново записывает изменённые страницы из буферного кэша на диск, помогая поддерживать актуальность данных и снижать пик нагрузок при массовых запросах

* **Stats Collector** собирает статистику, ведёт учет выполнения запросов, использования ресурсов и другой информации, необходимой для работы планировщика запросов и оптимизации системы

* **Autovacuum** - процесс очистки (об этом далее)

### Работа с памятью и хранением данных

PostgreSQL выделяет область общей памяти, используемую для:
  
* Хранения буферов данных (shared buffers)
* Управления системными блокировками
* Отслеживания состояния транзакций
* Хранения WAL-буферов

Данные хранятся в виде файлов на диске. Для взаимодействия с хранилищем данных используются специализированные модули доступа и загрузчик данных

### Обработка SQL-запросов

PostgreSQL обрабатывает запросы так:

1. **Прием запроса**. Запрос поступает через клиент к дочернему процессу, созданному Postmaster

2. **Парсинг**. SQL-текст разбивается на токены и строится синтаксическое дерево. Здесь производится проверка на ошибки 

3. **Рерайтинг**. Запрос преобразуется с учетом представлений, правил и триггеров

4. **Планирование и оптимизация**. Планировщик запросов анализирует различные стратегии выполнения, используя собранную статистику, и выбирает наиболее оптимальный план

5. **Исполнение**. Выполнение плана запроса: данные извлекаются, обрабатываются через узлы (фильтрация, сортировка, соединения и т.д.) и формируется результат

6. **Возврат результатов**. После выполнения запроса результаты возвращаются клиенту. Для операций, изменяющий данные, делается коммит изменений
   
### MVCC

PostgreSQL реализует механизм MVCC (multiversion concurrency control, многоверсионный контроль согласованности), позволяющий обеспечить согласованность данных при одновременном доступе множества пользователей

Внутри себя PostgreSQL хранит счетчик транзакций, который можно получить функцией `txid_current()`. При выполнении транзакции этот счетчик увеличивается. Каждая запись в отношении имеет системные атрибуты `xmin` и `xmax`

* Когда запись создается, ей присваивается значение счетчика в поле `xmin`
* Когда запись удаляется, она не удаляется, а просто присваивается значение счетчика в ее поле `xmax`
* Когда запись изменяется, на самом деле создается ее копия с изменными атрибутами, старой записи присваивается значение счетчика в поле `xmax`, а новой присваивается в поле `xmin`

Таким образом, эти атрибуты задают жизненный цикл каждого снимка каждой записи, чтобы соблюдать целостность данных.  
Помимо них есть еще `cmin` и `cmax`. Они обозначают жизненный цикл самой записи и не затрагиваются при обновлении записи

### Vacuum и Autovacuum

Так как MVCC требует очень много памяти на диске, нужны инструменты, очищающие неактуальные данные. В PostgreSQL есть:

* **Vacuum** - команда для очистки базы данных, которая удаляет "мертвые" строки (устаревшие версии записей, помеченные как удаленные) и сбрасывает счетчик транзакций, участвующий в механизме MVCC, тем самым предотвращая его переполнение

* **Autovacuum** - автоматическая версия процесса очистки, которая определяет необходимость очистки таблиц на основании внутренней статистики и автоматически запускает процесс Vacuum для удаления устаревших данных и реорганизации таблиц, что помогает поддерживать оптимальную производительность базы данных

