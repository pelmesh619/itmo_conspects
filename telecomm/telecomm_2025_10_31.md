## Лекция 9. Конфигурация с помощью DHCP и ICMP

Для работы сетевого узла ему нужно знать:

* Его собственный IP-адрес, маску сети
* IP-адрес шлюз, к которому нужно отправлять пакеты
* IP-адреса DNS-серверов
* имя домена
* время аренды адреса
* и так далее

Чтобы базово настроить узел, а именно присвоить ему IP-адрес в сети, можно применить один из трех подходов:

* Ручная конфигурация: вручную задается IP-адрес узла, маска сети и IP-адрес шлюза
* Автоконфигурирование: 

    * в IPv4-сети по стандарту RFC 3927, задающий link-local адрес в диапазоне `169.254.0.0/16`, сформированный на основе MAC-адреса
    * в IPv6-сети используется механизм SLAAC и протокол ICMPv6

* Централизованная конфигурация с помощью протокола DHCP

Для централизованной конфигурации и создали протокол DHCP (Dynamic Host Configuration Protocol), основным назначением которого является управление адресным пространством сети

Чтобы сетевому клиенту выдать узел, в сети должен быть подключен центральный DHCP-сервер, который управляет пулом (то есть пространством) адресов

Протокол DHCP создавался как расширение протокола BOOTP, использовавшегося ранее для IP-конфигурации сетевых узлов, поэтому DHCP-сервер использует порт UDP 67, а DHCP-клиент - 68

Алгоритм работы протокола DHCP таков:

* Клиент, подключившись к сети, посылает широковещательный пакет с сообщением `DHCPDISCOVER`. В заголовке пакета адрес и порт отправителя указаны как `0.0.0.0:68`, а получателя - `255.255.255.255:67`
* Сервер выделяет свободный IP-адрес и отвечает клиенту пакетом с сообщением `DHCPOFFER`, в заголовке которого указан адрес сервера как адрес отправителя и `255.255.255.255` как адрес получателя
* Клиент получает пакет, узнает адрес сервера и отвечает пакетом с сообщением `DHCPREQUEST`
* Сервер отправляет пакет с подтверждением `DHCPACK`

![Работа DHCP](./images/telecomm_dhcp_procedure.png)

Всего осуществляется 4 отправки сообщений между узлами вместо 2, чтобы убедиться, что узел работоспособен к моменту пользования адресом

В последнем пакете сервера указано время аренды адреса `T`. После времени `T` адрес становится недействительным и его нужно заново запрашивать. Однако его можно продлить:

* После времени `T/2` можно напрямую обратиться к DHCP-серверу, который выдал адрес, с сообщением `DHCPREQUEST`
* Если после нескольких попыток сервер не ответил до времени `7T/8`, то после времени `7T/8` клиент отправляет широковещательное сообщение `DHCPREQUEST`, и любой доступный сервер продлевает текущий адрес

### DHCPv4

Формат DHCPv4-пакета выглядит так:

![Формат DHCP](./images/telecomm_dhcp_message.png)

Он имеет следующие поля:

* Тип сообщения, 8 бит - либо `0x01`, если это запрос от клиента, либо `0x02`, если запрос от сервера клиенту
* Тип аппаратного адреса, 8 бит. Значения определены в RFC 1700, для MAC-адреса это `0x01`
* Длина аппаратного адреса в байтах, 8 бит (для MAC-адреса это `0x06`)
* Количество промежуточных маршрутизаторов (агентов ретрансляции DHCP), 8 бит
* Уникальный идентификатор транзакции, 32 бита, генерируется на стороне клиента. Благодаря нему, широковещательные пакеты различаются между разными DHCP-клиентами
* Время в секундах с момента начала процесса получения адреса, 16 бит, опционально
* Флаги, 16 бит
* IP-адрес клиента, если он имеется, 32 бита
* Новый, предложенный сервером IP-адрес клиента, 32 бита
* IP-адрес следующего сервера в цепочки сервисов, 32 бита. Если такового нет, то адрес этого DHCP-сервера
* IP-адрес агента ретрансляции, если таковой участвовал, 32 бита
* Аппаратный адрес (обычно MAC-адрес) клиента, 128 бит
* Опциональное имя сервера с нуль-терминатором, 64 байт
* Опциональное имя файла на сервере с нуль-терминатором для бездисковых узлов, 128 байт
* Опции, которые начинаются с магического числа `0x63825363`. Опции указываются списком в формате номер опции и данные. 
    
    * В опции 53 указывается тип сообщения: 1 - `DHCPDISCOVER`, 2 - `DHCPOFFER`, 3 - `DHCPREQUEST`, 4 - `DHCPDECLINE`, 5 - `DHCPACK`, 6 - `DHCPNAK`, 7 - `DHCPRELEASE`, 8 - `DHCPINFORM`
    * В опции 51 - время аренды адреса в секундах 
    * В опции 1 - маска сети
    * В опции 6 - список DNS-серверов

Помимо `DHCPDISCOVER`, `DHCPOFFER`, `DHCPREQUEST` и `DHCPACK` существуют другие сообщения:

* `DHCPNAK` - сообщение сервера клиенту о том, что адрес больше недействителен (например, при смене подсети)
* `DHCPDECLINE` - клиент отказывается от адреса, так как он уже используется соседним узлом в подсети, и просит другой адрес
* `DHCPRELEASE` - отказ клиента от использования адреса
* `DHCPINFORM` - просьба клиента о получении дополнительных параметрах сети
* и другие, определенные стандартами RFC 3203, RFC 4388, RFC 6926, RFC 7724

---

В локальной сети может не оказаться DHCP-сервера, а, так как широковещание не маршрутизируется, используют агенты ретрансляции DHCP (DCHP relay), которые пересылаются пакеты DHCP-серверам

Агенты ретрансляции могут знать про сервера, поэтому адреса в IP-пакете заменяться на те, маршрутизация к которым возможна, поэтому достаточно одного в локальной сети и в маршруте до DHCP-сервера

### DHCPv6

Для работы в IPv6-сетях протокол DHCP доработали, и появился DHCPv6. В нем:

* Отказались от BOOTP
* Вместо широковещания используется мультивещание по адресу `ff02::1:2`
* Адрес агента ретрансляции указывается как `ff05::1:3`
* Изменились порты UDP, 546 для клиента и 547 для сервера

Также появились два режима работы:

* Режим сохранения состояния клиента - Stateful DHCPv6 

    Такой режим аналогичен DHCPv4. В нем цель - это получить арендованный IPv6-адрес, маску сети и опции (DNS-сервера, время с помощью протокола NTP и так далее)

* Режим без сохранения состояния клиента - Stateless DHCPv6 

    Этот режим используется, когда IP-адрес настроен и нужно получить только опции

Также изменились сообщения:

1. `SOLICIT` - используется клиентом для поиска серверов (аналог `DHCPDISCOVER`)
2. `ADVERTISE` - DHCPv6-сервер сообщает о себе в ответ на `SOLICIT` (аналог `DHCPOFFER`)
3. `REQUEST` - клиент запрашивает параметры у конкретного сервера
4. `CONFIRM` - клиент подтверждает, что получил адрес
5. `RENEW` - клиент просит сервер, от которого уже получил параметры, продлить время их действия
6. `REPLY` - ответ сервера с параметрами или подтверждение ранее 
выданных параметров (аналог `DHCPACK`)
7. `RELEASE` - клиент сообщает серверу об освобождении ранее полученного адреса
8. `DECLINE` - клиент отклонил предложенный адрес, так как его уже кто-то использует
9. `INFORMATION-REQUEST` - запрос от клиента к серверу на выдачу 
опций, но не адреса

Также помимо `SOLICIT` -> `ADVERTISE` -> `REQUEST` -> `REPLY` появился механизм ускоренной выдачи адресов (Rapid Commit) `SOLICIT` -> `REPLY`, которая включается опцией в заголовке

Как было упомянуто, DHCPv6 позволяет выделять диапазон сети роутеру клиента (то есть Customer Premises Equipment), чтобы сам роутер мог делегировать адреса узлам в подсети

Также в DHCPv6 стало возможным несколькими способами производить конфигурацию:

* Используя только SLAAC (Stateless Address Autoconfiguration)
* Используя SLAAC и Stateless DHCPv6
* Используя Stateful DHCPv6
